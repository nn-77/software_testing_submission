<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AccountWebController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Stirling-PDF</a> &gt; <a href="index.source.html" class="el_package">stirling.software.SPDF.controller.web</a> &gt; <span class="el_source">AccountWebController.java</span></div><h1>AccountWebController.java</h1><pre class="source lang-java linenums">package stirling.software.SPDF.controller.web;

import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.Optional;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.ObjectMapper;

import io.swagger.v3.oas.annotations.tags.Tag;

import jakarta.servlet.http.HttpServletRequest;
import stirling.software.SPDF.model.Authority;
import stirling.software.SPDF.model.Role;
import stirling.software.SPDF.model.User;
import stirling.software.SPDF.repository.UserRepository;

@Controller
@Tag(name = &quot;Account Security&quot;, description = &quot;Account Security APIs&quot;)
<span class="nc" id="L29">public class AccountWebController {</span>

    @GetMapping(&quot;/login&quot;)
    public String login(HttpServletRequest request, Model model, Authentication authentication) {
<span class="nc bnc" id="L33" title="All 4 branches missed.">        if (authentication != null &amp;&amp; authentication.isAuthenticated()) {</span>
<span class="nc" id="L34">            return &quot;redirect:/&quot;;</span>
        }

<span class="nc" id="L37">        model.addAttribute(&quot;currentPage&quot;, &quot;login&quot;);</span>

<span class="nc bnc" id="L39" title="All 2 branches missed.">        if (request.getParameter(&quot;error&quot;) != null) {</span>

<span class="nc" id="L41">            model.addAttribute(&quot;error&quot;, request.getParameter(&quot;error&quot;));</span>
        }
<span class="nc bnc" id="L43" title="All 2 branches missed.">        if (request.getParameter(&quot;logout&quot;) != null) {</span>

<span class="nc" id="L45">            model.addAttribute(&quot;logoutMessage&quot;, &quot;You have been logged out.&quot;);</span>
        }

<span class="nc" id="L48">        return &quot;login&quot;;</span>
    }

    @Autowired
    private UserRepository userRepository; // Assuming you have a repository for user operations

    @PreAuthorize(&quot;hasRole('ROLE_ADMIN')&quot;)
    @GetMapping(&quot;/addUsers&quot;)
    public String showAddUserForm(Model model, Authentication authentication) {
<span class="nc" id="L57">        List&lt;User&gt; allUsers = userRepository.findAll();</span>
<span class="nc" id="L58">        Iterator&lt;User&gt; iterator = allUsers.iterator();</span>
<span class="nc" id="L59">        Map&lt;String, String&gt; roleDetails = Role.getAllRoleDetails();</span>

<span class="nc bnc" id="L61" title="All 2 branches missed.">        while (iterator.hasNext()) {</span>
<span class="nc" id="L62">            User user = iterator.next();</span>
<span class="nc bnc" id="L63" title="All 2 branches missed.">            if (user != null) {</span>
<span class="nc bnc" id="L64" title="All 2 branches missed.">                for (Authority authority : user.getAuthorities()) {</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">                    if (authority.getAuthority().equals(Role.INTERNAL_API_USER.getRoleId())) {</span>
<span class="nc" id="L66">                        iterator.remove();</span>
<span class="nc" id="L67">                        roleDetails.remove(Role.INTERNAL_API_USER.getRoleId());</span>
<span class="nc" id="L68">                        break; // Break out of the inner loop once the user is removed</span>
                    }
<span class="nc" id="L70">                }</span>
            }
<span class="nc" id="L72">        }</span>

<span class="nc" id="L74">        model.addAttribute(&quot;users&quot;, allUsers);</span>
<span class="nc" id="L75">        model.addAttribute(&quot;currentUsername&quot;, authentication.getName());</span>
<span class="nc" id="L76">        model.addAttribute(&quot;roleDetails&quot;, roleDetails);</span>
<span class="nc" id="L77">        return &quot;addUsers&quot;;</span>
    }

    @PreAuthorize(&quot;!hasAuthority('ROLE_DEMO_USER')&quot;)
    @GetMapping(&quot;/account&quot;)
    public String account(HttpServletRequest request, Model model, Authentication authentication) {
<span class="nc bnc" id="L83" title="All 4 branches missed.">        if (authentication == null || !authentication.isAuthenticated()) {</span>
<span class="nc" id="L84">            return &quot;redirect:/&quot;;</span>
        }
<span class="nc bnc" id="L86" title="All 4 branches missed.">        if (authentication != null &amp;&amp; authentication.isAuthenticated()) {</span>
<span class="nc" id="L87">            Object principal = authentication.getPrincipal();</span>

<span class="nc bnc" id="L89" title="All 2 branches missed.">            if (principal instanceof UserDetails) {</span>
                // Cast the principal object to UserDetails
<span class="nc" id="L91">                UserDetails userDetails = (UserDetails) principal;</span>

                // Retrieve username and other attributes
<span class="nc" id="L94">                String username = userDetails.getUsername();</span>

                // Fetch user details from the database
<span class="nc" id="L97">                Optional&lt;User&gt; user =</span>
<span class="nc" id="L98">                        userRepository.findByUsername(</span>
                                username); // Assuming findByUsername method exists
<span class="nc bnc" id="L100" title="All 2 branches missed.">                if (!user.isPresent()) {</span>
                    // Handle error appropriately
<span class="nc" id="L102">                    return &quot;redirect:/error&quot;; // Example redirection in case of error</span>
                }

                // Convert settings map to JSON string
<span class="nc" id="L106">                ObjectMapper objectMapper = new ObjectMapper();</span>
                String settingsJson;
                try {
<span class="nc" id="L109">                    settingsJson = objectMapper.writeValueAsString(user.get().getSettings());</span>
<span class="nc" id="L110">                } catch (JsonProcessingException e) {</span>
                    // Handle JSON conversion error
<span class="nc" id="L112">                    e.printStackTrace();</span>
<span class="nc" id="L113">                    return &quot;redirect:/error&quot;; // Example redirection in case of error</span>
<span class="nc" id="L114">                }</span>

                // Add attributes to the model
<span class="nc" id="L117">                model.addAttribute(&quot;username&quot;, username);</span>
<span class="nc" id="L118">                model.addAttribute(&quot;role&quot;, user.get().getRolesAsString());</span>
<span class="nc" id="L119">                model.addAttribute(&quot;settings&quot;, settingsJson);</span>
<span class="nc" id="L120">                model.addAttribute(&quot;changeCredsFlag&quot;, user.get().isFirstLogin());</span>
<span class="nc" id="L121">                model.addAttribute(&quot;currentPage&quot;, &quot;account&quot;);</span>
            }
<span class="nc" id="L123">        } else {</span>
<span class="nc" id="L124">            return &quot;redirect:/&quot;;</span>
        }
<span class="nc" id="L126">        return &quot;account&quot;;</span>
    }

    @PreAuthorize(&quot;!hasAuthority('ROLE_DEMO_USER')&quot;)
    @GetMapping(&quot;/change-creds&quot;)
    public String changeCreds(
            HttpServletRequest request, Model model, Authentication authentication) {
<span class="nc bnc" id="L133" title="All 4 branches missed.">        if (authentication == null || !authentication.isAuthenticated()) {</span>
<span class="nc" id="L134">            return &quot;redirect:/&quot;;</span>
        }
<span class="nc bnc" id="L136" title="All 4 branches missed.">        if (authentication != null &amp;&amp; authentication.isAuthenticated()) {</span>
<span class="nc" id="L137">            Object principal = authentication.getPrincipal();</span>

<span class="nc bnc" id="L139" title="All 2 branches missed.">            if (principal instanceof UserDetails) {</span>
                // Cast the principal object to UserDetails
<span class="nc" id="L141">                UserDetails userDetails = (UserDetails) principal;</span>

                // Retrieve username and other attributes
<span class="nc" id="L144">                String username = userDetails.getUsername();</span>

                // Fetch user details from the database
<span class="nc" id="L147">                Optional&lt;User&gt; user =</span>
<span class="nc" id="L148">                        userRepository.findByUsername(</span>
                                username); // Assuming findByUsername method exists
<span class="nc bnc" id="L150" title="All 2 branches missed.">                if (!user.isPresent()) {</span>
                    // Handle error appropriately
<span class="nc" id="L152">                    return &quot;redirect:/error&quot;; // Example redirection in case of error</span>
                }
                // Add attributes to the model
<span class="nc" id="L155">                model.addAttribute(&quot;username&quot;, username);</span>
            }
<span class="nc" id="L157">        } else {</span>
<span class="nc" id="L158">            return &quot;redirect:/&quot;;</span>
        }
<span class="nc" id="L160">        return &quot;change-creds&quot;;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>