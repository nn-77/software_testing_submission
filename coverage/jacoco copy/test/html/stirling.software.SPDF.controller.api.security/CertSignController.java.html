<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CertSignController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Stirling-PDF</a> &gt; <a href="index.source.html" class="el_package">stirling.software.SPDF.controller.api.security</a> &gt; <span class="el_source">CertSignController.java</span></div><h1>CertSignController.java</h1><pre class="source lang-java linenums">package stirling.software.SPDF.controller.api.security;

import java.io.ByteArrayInputStream;
import java.io.ByteArrayOutputStream;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.OutputStream;
import java.security.KeyStore;
import java.security.KeyStoreException;
import java.security.NoSuchAlgorithmException;
import java.security.PrivateKey;
import java.security.Security;
import java.security.UnrecoverableKeyException;
import java.security.cert.Certificate;
import java.security.cert.CertificateException;
import java.security.cert.CertificateFactory;
import java.util.Calendar;

import org.apache.pdfbox.Loader;
import org.apache.pdfbox.examples.signature.CreateSignatureBase;
import org.apache.pdfbox.pdmodel.PDDocument;
import org.apache.pdfbox.pdmodel.interactive.digitalsignature.PDSignature;
import org.bouncycastle.asn1.pkcs.PrivateKeyInfo;
import org.bouncycastle.jce.provider.BouncyCastleProvider;
import org.bouncycastle.openssl.PEMDecryptorProvider;
import org.bouncycastle.openssl.PEMEncryptedKeyPair;
import org.bouncycastle.openssl.PEMKeyPair;
import org.bouncycastle.openssl.PEMParser;
import org.bouncycastle.openssl.jcajce.JcaPEMKeyConverter;
import org.bouncycastle.openssl.jcajce.JceOpenSSLPKCS8DecryptorProviderBuilder;
import org.bouncycastle.openssl.jcajce.JcePEMDecryptorProviderBuilder;
import org.bouncycastle.operator.InputDecryptorProvider;
import org.bouncycastle.operator.OperatorCreationException;
import org.bouncycastle.pkcs.PKCS8EncryptedPrivateKeyInfo;
import org.bouncycastle.pkcs.PKCSException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import io.github.pixee.security.Filenames;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;

import stirling.software.SPDF.model.api.security.SignPDFWithCertRequest;
import stirling.software.SPDF.utils.WebResponseUtils;

@RestController
@RequestMapping(&quot;/api/v1/security&quot;)
@Tag(name = &quot;Security&quot;, description = &quot;Security APIs&quot;)
<span class="nc" id="L55">public class CertSignController {</span>

<span class="nc" id="L57">    private static final Logger logger = LoggerFactory.getLogger(CertSignController.class);</span>

    static {
<span class="nc" id="L60">        Security.addProvider(new BouncyCastleProvider());</span>
<span class="nc" id="L61">    }</span>

    class CreateSignature extends CreateSignatureBase {
        public CreateSignature(KeyStore keystore, char[] pin)
                throws KeyStoreException,
                        UnrecoverableKeyException,
                        NoSuchAlgorithmException,
                        IOException,
<span class="nc" id="L69">                        CertificateException {</span>
<span class="nc" id="L70">            super(keystore, pin);</span>
<span class="nc" id="L71">        }</span>
    }

    @PostMapping(consumes = &quot;multipart/form-data&quot;, value = &quot;/cert-sign&quot;)
    @Operation(
            summary = &quot;Sign PDF with a Digital Certificate&quot;,
            description =
                    &quot;This endpoint accepts a PDF file, a digital certificate and related information to sign the PDF. It then returns the digitally signed PDF file. Input:PDF Output:PDF Type:SISO&quot;)
    public ResponseEntity&lt;byte[]&gt; signPDFWithCert(@ModelAttribute SignPDFWithCertRequest request)
            throws Exception {
<span class="nc" id="L81">        MultipartFile pdf = request.getFileInput();</span>
<span class="nc" id="L82">        String certType = request.getCertType();</span>
<span class="nc" id="L83">        MultipartFile privateKeyFile = request.getPrivateKeyFile();</span>
<span class="nc" id="L84">        MultipartFile certFile = request.getCertFile();</span>
<span class="nc" id="L85">        MultipartFile p12File = request.getP12File();</span>
<span class="nc" id="L86">        MultipartFile jksfile = request.getJksFile();</span>
<span class="nc" id="L87">        String password = request.getPassword();</span>
<span class="nc" id="L88">        Boolean showSignature = request.isShowSignature();</span>
<span class="nc" id="L89">        String reason = request.getReason();</span>
<span class="nc" id="L90">        String location = request.getLocation();</span>
<span class="nc" id="L91">        String name = request.getName();</span>
<span class="nc" id="L92">        Integer pageNumber = request.getPageNumber();</span>

<span class="nc bnc" id="L94" title="All 2 branches missed.">        if (certType == null) {</span>
<span class="nc" id="L95">            throw new IllegalArgumentException(&quot;Cert type must be provided&quot;);</span>
        }

<span class="nc" id="L98">        KeyStore ks = null;</span>

<span class="nc bnc" id="L100" title="All 4 branches missed.">        switch (certType) {</span>
            case &quot;PEM&quot;:
<span class="nc" id="L102">                ks = KeyStore.getInstance(&quot;JKS&quot;);</span>
<span class="nc" id="L103">                ks.load(null);</span>
<span class="nc" id="L104">                PrivateKey privateKey = getPrivateKeyFromPEM(privateKeyFile.getBytes(), password);</span>
<span class="nc" id="L105">                Certificate cert = (Certificate) getCertificateFromPEM(certFile.getBytes());</span>
<span class="nc" id="L106">                ks.setKeyEntry(</span>
<span class="nc" id="L107">                        &quot;alias&quot;, privateKey, password.toCharArray(), new Certificate[] {cert});</span>
<span class="nc" id="L108">                break;</span>
            case &quot;PKCS12&quot;:
<span class="nc" id="L110">                ks = KeyStore.getInstance(&quot;PKCS12&quot;);</span>
<span class="nc" id="L111">                ks.load(p12File.getInputStream(), password.toCharArray());</span>
<span class="nc" id="L112">                break;</span>
            case &quot;JKS&quot;:
<span class="nc" id="L114">                ks = KeyStore.getInstance(&quot;JKS&quot;);</span>
<span class="nc" id="L115">                ks.load(jksfile.getInputStream(), password.toCharArray());</span>
<span class="nc" id="L116">                break;</span>
            default:
<span class="nc" id="L118">                throw new IllegalArgumentException(&quot;Invalid cert type: &quot; + certType);</span>
        }

        // TODO: page number

<span class="nc" id="L123">        CreateSignature createSignature = new CreateSignature(ks, password.toCharArray());</span>
<span class="nc" id="L124">        ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>
<span class="nc" id="L125">        sign(pdf.getBytes(), baos, createSignature, name, location, reason);</span>
<span class="nc" id="L126">        return WebResponseUtils.boasToWebResponse(</span>
                baos,
<span class="nc" id="L128">                Filenames.toSimpleFileName(pdf.getOriginalFilename()).replaceFirst(&quot;[.][^.]+$&quot;, &quot;&quot;)</span>
                        + &quot;_signed.pdf&quot;);
    }

    private static void sign(
            byte[] input,
            OutputStream output,
            CreateSignature instance,
            String name,
            String location,
            String reason) {
<span class="nc" id="L139">        try (PDDocument doc = Loader.loadPDF(input)) {</span>
<span class="nc" id="L140">            PDSignature signature = new PDSignature();</span>
<span class="nc" id="L141">            signature.setFilter(PDSignature.FILTER_ADOBE_PPKLITE);</span>
<span class="nc" id="L142">            signature.setSubFilter(PDSignature.SUBFILTER_ADBE_PKCS7_DETACHED);</span>
<span class="nc" id="L143">            signature.setName(name);</span>
<span class="nc" id="L144">            signature.setLocation(location);</span>
<span class="nc" id="L145">            signature.setReason(reason);</span>
<span class="nc" id="L146">            signature.setSignDate(Calendar.getInstance());</span>

<span class="nc" id="L148">            doc.addSignature(signature, instance);</span>
<span class="nc" id="L149">            doc.saveIncremental(output);</span>
<span class="nc" id="L150">        } catch (Exception e) {</span>
<span class="nc" id="L151">            e.printStackTrace();</span>
<span class="nc" id="L152">        }</span>
<span class="nc" id="L153">    }</span>

    private PrivateKey getPrivateKeyFromPEM(byte[] pemBytes, String password)
            throws IOException, OperatorCreationException, PKCSException {
<span class="nc" id="L157">        try (PEMParser pemParser =</span>
                new PEMParser(new InputStreamReader(new ByteArrayInputStream(pemBytes)))) {
<span class="nc" id="L159">            Object pemObject = pemParser.readObject();</span>
<span class="nc" id="L160">            JcaPEMKeyConverter converter = new JcaPEMKeyConverter().setProvider(&quot;BC&quot;);</span>
            PrivateKeyInfo pkInfo;
<span class="nc bnc" id="L162" title="All 2 branches missed.">            if (pemObject instanceof PKCS8EncryptedPrivateKeyInfo) {</span>
<span class="nc" id="L163">                InputDecryptorProvider decProv =</span>
<span class="nc" id="L164">                        new JceOpenSSLPKCS8DecryptorProviderBuilder().build(password.toCharArray());</span>
<span class="nc" id="L165">                pkInfo = ((PKCS8EncryptedPrivateKeyInfo) pemObject).decryptPrivateKeyInfo(decProv);</span>
<span class="nc bnc" id="L166" title="All 2 branches missed.">            } else if (pemObject instanceof PEMEncryptedKeyPair) {</span>
<span class="nc" id="L167">                PEMDecryptorProvider decProv =</span>
<span class="nc" id="L168">                        new JcePEMDecryptorProviderBuilder().build(password.toCharArray());</span>
<span class="nc" id="L169">                pkInfo =</span>
                        ((PEMEncryptedKeyPair) pemObject)
<span class="nc" id="L171">                                .decryptKeyPair(decProv)</span>
<span class="nc" id="L172">                                .getPrivateKeyInfo();</span>
<span class="nc" id="L173">            } else {</span>
<span class="nc" id="L174">                pkInfo = ((PEMKeyPair) pemObject).getPrivateKeyInfo();</span>
            }
<span class="nc" id="L176">            return converter.getPrivateKey(pkInfo);</span>
        }
    }

    private Certificate getCertificateFromPEM(byte[] pemBytes)
            throws IOException, CertificateException {
<span class="nc" id="L182">        try (ByteArrayInputStream bis = new ByteArrayInputStream(pemBytes)) {</span>
<span class="nc" id="L183">            return CertificateFactory.getInstance(&quot;X.509&quot;).generateCertificate(bis);</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>