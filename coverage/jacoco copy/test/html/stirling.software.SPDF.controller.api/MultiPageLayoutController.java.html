<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MultiPageLayoutController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Stirling-PDF</a> &gt; <a href="index.source.html" class="el_package">stirling.software.SPDF.controller.api</a> &gt; <span class="el_source">MultiPageLayoutController.java</span></div><h1>MultiPageLayoutController.java</h1><pre class="source lang-java linenums">package stirling.software.SPDF.controller.api;

import java.awt.Color;
import java.io.ByteArrayOutputStream;
import java.io.IOException;

import org.apache.pdfbox.Loader;
import org.apache.pdfbox.multipdf.LayerUtility;
import org.apache.pdfbox.pdmodel.PDDocument;
import org.apache.pdfbox.pdmodel.PDPage;
import org.apache.pdfbox.pdmodel.PDPageContentStream;
import org.apache.pdfbox.pdmodel.common.PDRectangle;
import org.apache.pdfbox.pdmodel.graphics.form.PDFormXObject;
import org.apache.pdfbox.util.Matrix;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.multipart.MultipartFile;

import io.github.pixee.security.Filenames;
import io.swagger.v3.oas.annotations.Operation;
import io.swagger.v3.oas.annotations.tags.Tag;

import stirling.software.SPDF.model.api.general.MergeMultiplePagesRequest;
import stirling.software.SPDF.utils.WebResponseUtils;

@RestController
@RequestMapping(&quot;/api/v1/general&quot;)
@Tag(name = &quot;General&quot;, description = &quot;General APIs&quot;)
<span class="nc" id="L34">public class MultiPageLayoutController {</span>

<span class="nc" id="L36">    private static final Logger logger = LoggerFactory.getLogger(MultiPageLayoutController.class);</span>

    @PostMapping(value = &quot;/multi-page-layout&quot;, consumes = &quot;multipart/form-data&quot;)
    @Operation(
            summary = &quot;Merge multiple pages of a PDF document into a single page&quot;,
            description =
                    &quot;This operation takes an input PDF file and the number of pages to merge into a single sheet in the output PDF file. Input:PDF Output:PDF Type:SISO&quot;)
    public ResponseEntity&lt;byte[]&gt; mergeMultiplePagesIntoOne(
            @ModelAttribute MergeMultiplePagesRequest request) throws IOException {

<span class="nc" id="L46">        int pagesPerSheet = request.getPagesPerSheet();</span>
<span class="nc" id="L47">        MultipartFile file = request.getFileInput();</span>
<span class="nc" id="L48">        boolean addBorder = request.isAddBorder();</span>

<span class="nc bnc" id="L50" title="All 4 branches missed.">        if (pagesPerSheet != 2</span>
                &amp;&amp; pagesPerSheet != 3
<span class="nc bnc" id="L52" title="All 2 branches missed.">                &amp;&amp; pagesPerSheet != (int) Math.sqrt(pagesPerSheet) * Math.sqrt(pagesPerSheet)) {</span>
<span class="nc" id="L53">            throw new IllegalArgumentException(&quot;pagesPerSheet must be 2, 3 or a perfect square&quot;);</span>
        }

        int cols =
<span class="nc bnc" id="L57" title="All 4 branches missed.">                pagesPerSheet == 2 || pagesPerSheet == 3</span>
<span class="nc" id="L58">                        ? pagesPerSheet</span>
<span class="nc" id="L59">                        : (int) Math.sqrt(pagesPerSheet);</span>
<span class="nc bnc" id="L60" title="All 4 branches missed.">        int rows = pagesPerSheet == 2 || pagesPerSheet == 3 ? 1 : (int) Math.sqrt(pagesPerSheet);</span>

<span class="nc" id="L62">        PDDocument sourceDocument = Loader.loadPDF(file.getBytes());</span>
<span class="nc" id="L63">        PDDocument newDocument = new PDDocument();</span>
<span class="nc" id="L64">        PDPage newPage = new PDPage(PDRectangle.A4);</span>
<span class="nc" id="L65">        newDocument.addPage(newPage);</span>

<span class="nc" id="L67">        int totalPages = sourceDocument.getNumberOfPages();</span>
<span class="nc" id="L68">        float cellWidth = newPage.getMediaBox().getWidth() / cols;</span>
<span class="nc" id="L69">        float cellHeight = newPage.getMediaBox().getHeight() / rows;</span>

<span class="nc" id="L71">        PDPageContentStream contentStream =</span>
                new PDPageContentStream(
                        newDocument, newPage, PDPageContentStream.AppendMode.APPEND, true, true);
<span class="nc" id="L74">        LayerUtility layerUtility = new LayerUtility(newDocument);</span>

<span class="nc" id="L76">        float borderThickness = 1.5f; // Specify border thickness as required</span>
<span class="nc" id="L77">        contentStream.setLineWidth(borderThickness);</span>
<span class="nc" id="L78">        contentStream.setStrokingColor(Color.BLACK);</span>

<span class="nc bnc" id="L80" title="All 2 branches missed.">        for (int i = 0; i &lt; totalPages; i++) {</span>
<span class="nc bnc" id="L81" title="All 4 branches missed.">            if (i != 0 &amp;&amp; i % pagesPerSheet == 0) {</span>
                // Close the current content stream and create a new page and content stream
<span class="nc" id="L83">                contentStream.close();</span>
<span class="nc" id="L84">                newPage = new PDPage(PDRectangle.A4);</span>
<span class="nc" id="L85">                newDocument.addPage(newPage);</span>
<span class="nc" id="L86">                contentStream =</span>
                        new PDPageContentStream(
                                newDocument,
                                newPage,
                                PDPageContentStream.AppendMode.APPEND,
                                true,
                                true);
            }

<span class="nc" id="L95">            PDPage sourcePage = sourceDocument.getPage(i);</span>
<span class="nc" id="L96">            PDRectangle rect = sourcePage.getMediaBox();</span>
<span class="nc" id="L97">            float scaleWidth = cellWidth / rect.getWidth();</span>
<span class="nc" id="L98">            float scaleHeight = cellHeight / rect.getHeight();</span>
<span class="nc" id="L99">            float scale = Math.min(scaleWidth, scaleHeight);</span>

<span class="nc" id="L101">            int adjustedPageIndex =</span>
                    i % pagesPerSheet; // This will reset the index for every new page
<span class="nc" id="L103">            int rowIndex = adjustedPageIndex / cols;</span>
<span class="nc" id="L104">            int colIndex = adjustedPageIndex % cols;</span>

<span class="nc" id="L106">            float x = colIndex * cellWidth + (cellWidth - rect.getWidth() * scale) / 2;</span>
<span class="nc" id="L107">            float y =</span>
<span class="nc" id="L108">                    newPage.getMediaBox().getHeight()</span>
                            - ((rowIndex + 1) * cellHeight
<span class="nc" id="L110">                                    - (cellHeight - rect.getHeight() * scale) / 2);</span>

<span class="nc" id="L112">            contentStream.saveGraphicsState();</span>
<span class="nc" id="L113">            contentStream.transform(Matrix.getTranslateInstance(x, y));</span>
<span class="nc" id="L114">            contentStream.transform(Matrix.getScaleInstance(scale, scale));</span>

<span class="nc" id="L116">            PDFormXObject formXObject = layerUtility.importPageAsForm(sourceDocument, i);</span>
<span class="nc" id="L117">            contentStream.drawForm(formXObject);</span>

<span class="nc" id="L119">            contentStream.restoreGraphicsState();</span>

<span class="nc bnc" id="L121" title="All 2 branches missed.">            if (addBorder) {</span>
                // Draw border around each page
<span class="nc" id="L123">                float borderX = colIndex * cellWidth;</span>
<span class="nc" id="L124">                float borderY = newPage.getMediaBox().getHeight() - (rowIndex + 1) * cellHeight;</span>
<span class="nc" id="L125">                contentStream.addRect(borderX, borderY, cellWidth, cellHeight);</span>
<span class="nc" id="L126">                contentStream.stroke();</span>
            }
        }

<span class="nc" id="L130">        contentStream.close(); // Close the final content stream</span>
<span class="nc" id="L131">        sourceDocument.close();</span>

<span class="nc" id="L133">        ByteArrayOutputStream baos = new ByteArrayOutputStream();</span>
<span class="nc" id="L134">        newDocument.save(baos);</span>
<span class="nc" id="L135">        newDocument.close();</span>

<span class="nc" id="L137">        byte[] result = baos.toByteArray();</span>
<span class="nc" id="L138">        return WebResponseUtils.bytesToWebResponse(</span>
                result,
<span class="nc" id="L140">                Filenames.toSimpleFileName(file.getOriginalFilename()).replaceFirst(&quot;[.][^.]+$&quot;, &quot;&quot;)</span>
                        + &quot;_layoutChanged.pdf&quot;);
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.8.202204050719</span></div></body></html>